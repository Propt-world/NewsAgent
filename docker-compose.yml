services:
  # --- 1. The Message Broker (Redis) ---
  redis:
    image: redis:alpine
    container_name: newsagent_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # --- 2. The Database (MongoDB) ---
  mongo:
    image: mongo:latest
    container_name: newsagent_mongo
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    # Optional: Basic healthcheck
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  # --- 2.5. Database Initialization ---
  db-init:
    build: .
    container_name: newsagent_db_init
    command: python src/scripts/init_db.py
    volumes:
      - .:/app
    environment:
      - DATABASE_URL=mongodb://mongo:27017
      - MONGO_DB_NAME=newsagent
      # Pass through any other env vars that init_db might need
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - TAVILY_API_KEY=${TAVILY_API_KEY}
    env_file:
      - .env
    depends_on:
      mongo:
        condition: service_healthy
    restart: "no"  # Only run once, don't restart on failure

  # --- 3. The API (Producer) ---
  api:
    build: .
    container_name: newsagent_api
    command: uvicorn src.main:api --host 0.0.0.0 --port 8000 --reload
    ports:
      - "8000:8000"
    volumes:
      - .:/app
    dns:
      - 8.8.8.8
      - 8.8.4.4
    environment:
      # Network: Service names are hostnames
      - REDIS_URL=redis://redis:6379/0
      # Use the container name 'mongo' for the connection
      - DATABASE_URL=mongodb://mongo:27017
      - MONGO_DB_NAME=newsagent

      # Pass through keys from your local machine
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      - WEBHOOK_URL=${WEBHOOK_URL}
      - WEBHOOK_SECRET=${WEBHOOK_SECRET}

      # Email Settings
      - SMTP_SERVER=${SMTP_SERVER}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_EMAIL=${SMTP_EMAIL}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
    env_file:
      - .env
    depends_on:
      redis:
        condition: service_healthy
      mongo:
        condition: service_healthy
      db-init:
        condition: service_completed_successfully

  # --- 4. The Worker (Consumer) ---
  worker:
    build: .
    container_name: newsagent_worker
    command: python src/worker.py
    volumes:
      - .:/app
    dns:
      - 8.8.8.8
      - 8.8.4.4
    environment:
      - REDIS_URL=redis://redis:6379/0
      - DATABASE_URL=mongodb://mongo:27017
      - MONGO_DB_NAME=newsagent

      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      - WEBHOOK_URL=${WEBHOOK_URL}
      - WEBHOOK_SECRET=${WEBHOOK_SECRET}

      # Email Settings
      - SMTP_SERVER=${SMTP_SERVER}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_EMAIL=${SMTP_EMAIL}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
    env_file:
      - .env
    depends_on:
      redis:
        condition: service_healthy
      mongo:
        condition: service_healthy
      db-init:
        condition: service_completed_successfully

  # --- 5. The Scheduler Service ---
  scheduler:
    build: .
    container_name: newsagent_scheduler
    # Runs the new scheduler/main.py
    command: uvicorn src.scheduler.main:app --host 0.0.0.0 --port 8001 --reload
    ports:
      - "8001:8001"
    volumes:
      - .:/app
    dns:
      - 8.8.8.8
      - 8.8.4.4
    environment:
      # Connects to the same DB to store sources/archives
      - DATABASE_URL=mongodb://mongo:27017
      - MONGO_DB_NAME=newsagent
      # Needs to know where the main API is to submit jobs
      - MAIN_API_URL=http://api:8000
      # Source ID for manually submitted articles (can be overridden via .env)
      - SUBMISSION_SOURCE_ID=${SUBMISSION_SOURCE_ID:-newsagent_scheduled_source}

      # Email Settings for Failure Notifications
      - SMTP_SERVER=${SMTP_SERVER}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_EMAIL=${SMTP_EMAIL}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
    env_file:
      - .env
    depends_on:
      mongo:
        condition: service_healthy
      db-init:
        condition: service_completed_successfully
      api:
        # Scheduler needs API to be up to submit jobs
        condition: service_started

volumes:
  redis_data:
  mongo_data: